<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lippu Events Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Preview Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700;900&display=swap"
    rel="stylesheet">
</head>

<body>
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- Load Renderer Modules -->
  <script type="module">
    import { renderEvent } from "../src/render.js";

    // Register Styles
    CMS.registerPreviewStyle("../src/style.css");
    // Also fonts need to be registered or just loaded via main frame (which works for google fonts usually if not blocked)
    // Actually, registerPreviewStyle behaves by adding links to iframe. 
    CMS.registerPreviewStyle("https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700;900&display=swap");

    // Create the Preview Component
    const EventPreview = createClass({
      componentDidMount() {
        this.renderContent();
      },
      componentDidUpdate() {
        this.renderContent();
      },
      async renderContent() {
        const entry = this.props.entry;
        // Convert Immutable Map to JS object
        const data = entry.toJS().data;

        // Render into the ref
        if (this.previewRef) {
          await renderEvent(data, this.previewRef);
        }
      },
      render() {
        // Safe check for slug
        const slug = this.props.entry.getIn(['data', 'slug']) || 'demo';
        // Construct live url - adjust domain as needed
        // Real production domain
        const PARENT_DOMAIN = 'lippu.app';

        // Construct live urls
        const isLocal = window.location.hostname === 'localhost';

        let liveUrl = `http://localhost:3001/?event=${slug}`; // Local dev uses 3001
        let prettyUrl = liveUrl;

        if (!isLocal) {
          // If we are on netlify or lippu.app, we can use the subdomain logic
          // Note: Netlify usually hosts the admin on the main domain or a subdomain
          // We assume events are at [slug].lippu.app
          prettyUrl = `https://${slug}.${PARENT_DOMAIN}`;
        }

        return h('div', {},
          // Top Bar for Actions
          h('div', {
            style: {
              padding: '20px',
              background: '#1a1a1a',
              borderBottom: '1px solid #333',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              color: '#fff',
              fontFamily: 'sans-serif'
            }
          },
            h('span', {}, `Previewing: ${slug}`),
            h('a', {
              href: prettyUrl,
              target: '_blank',
              style: {
                background: '#7B32FF',
                color: '#fff',
                textDecoration: 'none',
                padding: '8px 16px',
                borderRadius: '6px',
                fontWeight: 'bold',
                fontSize: '14px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }
            }, 'â†— Abrir Sitio Real')
          ),

          // Container for the preview rendering
          h('div', {
            id: 'preview-root',
            ref: ref => this.previewRef = ref,
            // Inline style to match index.html #root settings for correct context
            style: {
              maxWidth: '1440px',
              margin: '0 auto',
              padding: '0',
              display: 'flex',
              flexDirection: 'column',
              gap: '0'
            }
          })
        );
      }
    });

    // Register to 'events' collection
    CMS.registerPreviewTemplate("events", EventPreview);
  </script>
</body>

</html>