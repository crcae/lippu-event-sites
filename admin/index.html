<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lippu Events Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Import Map for module resolution -->
  <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
  </script>

  <!-- Preview Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700;900&display=swap"
    rel="stylesheet">
</head>

<body>
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script>window.CMS_MANUAL_INIT = true;</script>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

  <!-- Load Renderer Modules -->
  <script type="module">
    import { renderEvent } from "../src/render.js";
    import { GeminiAgent } from "../src/gemini.js";

    // Register Styles
    CMS.registerPreviewStyle("../src/style.css");
    // Also fonts need to be registered or just loaded via main frame (which works for google fonts usually if not blocked)
    // Actually, registerPreviewStyle behaves by adding links to iframe. 
    CMS.registerPreviewStyle("https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700;900&display=swap");

    /**
     * GeminiAssistant: A custom UI component to interact with Gemini AI
     */
    const GeminiAssistant = createClass({
      getInitialState() {
        return {
          prompt: '',
          loading: false,
          apiKey: localStorage.getItem('GEMINI_API_KEY') || ''
        };
      },
      handlePromptChange(e) {
        this.setState({ prompt: e.target.value });
      },
      handleKeyChange(e) {
        const key = e.target.value;
        this.setState({ apiKey: key });
        localStorage.setItem('GEMINI_API_KEY', key);
      },
      async handleGenerate() {
        if (!this.state.apiKey) {
          alert("Por favor ingresa tu API Key de Gemini");
          return;
        }
        if (!this.state.prompt) return;

        this.setState({ loading: true });
        try {
          const agent = new GeminiAgent(this.state.apiKey);
          const currentHTML = this.props.value || '';
          const newHTML = await agent.generateHTML(this.state.prompt, { currentHTML });

          // Update the CMS field value
          this.props.onChange(newHTML);
          this.setState({ prompt: '' });
        } catch (e) {
          alert("Error: " + e.message);
        } finally {
          this.setState({ loading: false });
        }
      },
      render() {
        return h('div', {
          style: {
            background: '#222',
            padding: '24px',
            borderRadius: '12px',
            color: '#fff',
            fontFamily: 'system-ui',
            marginBottom: '20px',
            border: '1px solid #444'
          }
        },
          h('h3', { style: { margin: '0 0 16px 0', color: '#109bff' } }, '✨ Asistente de IA (Gemini)'),

          h('div', { style: { marginBottom: '16px' } },
            h('label', { style: { display: 'block', marginBottom: '8px', fontSize: '12px', opacity: 0.7 } }, 'API Key de Gemini'),
            h('input', {
              type: 'password',
              value: this.state.apiKey,
              onChange: this.handleKeyChange,
              placeholder: 'Paste your API key here',
              style: {
                width: '100%',
                padding: '10px',
                background: '#111',
                border: '1px solid #333',
                borderRadius: '6px',
                color: '#fff'
              }
            })
          ),

          h('div', { style: { display: 'flex', gap: '10px' } },
            h('input', {
              value: this.state.prompt,
              onChange: this.handlePromptChange,
              placeholder: '¿Qué quieres crear o cambiar? (ej: "Añade una sección de mapa")',
              style: {
                flex: 1,
                padding: '12px',
                background: '#111',
                border: '1px solid #333',
                borderRadius: '8px',
                color: '#fff'
              }
            }),
            h('button', {
              onClick: this.handleGenerate,
              disabled: this.state.loading,
              style: {
                background: '#109bff',
                color: '#fff',
                border: 'none',
                padding: '0 24px',
                borderRadius: '8px',
                fontWeight: 'bold',
                cursor: this.state.loading ? 'wait' : 'pointer',
                opacity: this.state.loading ? 0.7 : 1
              }
            }, this.state.loading ? 'Generando...' : 'Generar')
          ),
          'La IA generará solo código HTML/CSS limpio compatible con el sistema.'
        ),

          h('div', { style: { marginTop: '20px', borderTop: '1px solid #444', paddingTop: '20px' } },
            h('label', { style: { display: 'block', marginBottom: '8px', fontSize: '12px', opacity: 0.7 } }, 'Edición Manual HTML'),
            h('textarea', {
              value: this.props.value || '',
              onChange: (e) => this.props.onChange(e.target.value),
              style: {
                width: '100%',
                minHeight: '300px',
                padding: '12px',
                background: '#1a1a1a',
                border: '1px solid #333',
                borderRadius: '8px',
                color: '#ddd',
                fontFamily: 'monospace',
                fontSize: '13px',
                lineHeight: '1.5',
                resize: 'vertical'
              }
            })
          )
        );
      }
    });

    // Register the AI field as a custom widget
    CMS.registerWidget("gemini-ai", GeminiAssistant);

    // Create the Preview Component
    const EventPreview = createClass({
      componentDidMount() {
        this.renderContent();
      },
      componentDidUpdate() {
        this.renderContent();
      },
      async renderContent() {
        const entry = this.props.entry;
        // Convert Immutable Map to JS object
        const data = entry.toJS().data;

        // Render into the ref
        if (this.previewRef) {
          await renderEvent(data, this.previewRef);
        }
      },
      render() {
        // Safe check for slug
        const slug = this.props.entry.getIn(['data', 'slug']) || 'demo';
        // Construct live url - adjust domain as needed
        // Real production domain
        const PARENT_DOMAIN = 'lippu.app';

        // Construct live urls
        const isLocal = window.location.hostname === 'localhost';

        let liveUrl = `http://localhost:3001/?event=${slug}`; // Local dev uses 3001
        let prettyUrl = liveUrl;

        if (!isLocal) {
          // If we are on netlify or lippu.app, we can use the subdomain logic
          // Note: Netlify usually hosts the admin on the main domain or a subdomain
          // We assume events are at [slug].lippu.app
          prettyUrl = `https://${slug}.${PARENT_DOMAIN}`;
        }

        return h('div', {},
          // Top Bar for Actions
          h('div', {
            style: {
              padding: '20px',
              background: '#1a1a1a',
              borderBottom: '1px solid #333',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              color: '#fff',
              fontFamily: 'sans-serif'
            }
          },
            h('span', {}, `Previewing: ${slug}`),
            h('a', {
              href: prettyUrl,
              target: '_blank',
              style: {
                background: '#7B32FF',
                color: '#fff',
                textDecoration: 'none',
                padding: '8px 16px',
                borderRadius: '6px',
                fontWeight: 'bold',
                fontSize: '14px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }
            }, '↗ Abrir Sitio Real')
          ),

          // Container for the preview rendering
          h('div', {
            id: 'preview-root',
            ref: ref => this.previewRef = ref,
            // Inline style to match index.html #root settings for correct context
            style: {
              maxWidth: '1440px',
              margin: '0 auto',
              padding: '0',
              display: 'flex',
              flexDirection: 'column',
              gap: '0'
            }
          })
        );
      }
    });

    // Register to 'events' collection
    CMS.registerPreviewTemplate("events", EventPreview);

    // Initialize CMS manually after widgets are registered
    CMS.init();
  </script>
</body>

</html>